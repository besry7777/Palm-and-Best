<script>
// Canvas & Context
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// --- การตั้งค่าเกม ---
const TILE_SIZE = 64;
const world = {
  width: 2000,
  height: 1500
};

// --- ตัวละครและ NPC ---
const player = {
  x: world.width / 2, y: world.height / 2, // เริ่มกลางแมพ
  width: 48, height: 48,
  speed: 4,
  dx: 0, // ทิศทางการเคลื่อนที่แนวนอน
  dy: 0  // ทิศทางการเคลื่อนที่แนวตั้ง
};

const npc = {
  x: world.width / 2 + 150, y: world.height / 2 - 50,
  width: 48, height: 48
};

// --- กล้อง ---
const camera = {
  x: 0,
  y: 0,
  width: window.innerWidth,
  height: window.innerHeight
};

// --- การควบคุม ---
const keys = { up: false, down: false, left: false, right: false };
let actionPressed = false;

// --- โหลด Assets ---
let grassPattern;

// ฟังก์ชันโหลดรูปภาพด้วย Promise
function loadImage(src) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.crossOrigin = "Anonymous"; // เพิ่มบรรทัดนี้เพื่อแก้ปัญหา CORS ที่อาจเกิดขึ้นกับ Imgur
    img.onload = () => resolve(img);
    img.onerror = reject;
    img.src = src;
  });
}

// --- ฟังก์ชันหลัก ---
async function initializeGame() {
  // โหลดรูปภาพทั้งหมดก่อนเริ่มเกม
  try {
    const [playerImg, npcImg, grassImg] = await Promise.all([
      //  vvv  เปลี่ยนเป็นลิงก์รูปที่ใช้งานได้จริงแล้ว  vvv
      loadImage('https://i.imgur.com/MieLq23.png'), // รูป Player สำรอง
      loadImage('https://i.imgur.com/V2wNn7g.png'), // รูป NPC สำรอง
      loadImage('https://i.imgur.com/ihDJe4n.png')  // รูปพื้นหญ้า (ลิงก์เดิม)
    ]);
    
    // สร้าง pattern สำหรับพื้นหลัง
    grassPattern = ctx.createPattern(grassImg, 'repeat');
    
    // ตั้งค่าเริ่มต้น
    setupControls();
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);
    
    // เริ่ม Game Loop
    gameLoop(playerImg, npcImg); // ส่งรูปที่โหลดแล้วเข้าไปใน loop

  } catch (error) {
    console.error("ไม่สามารถโหลดรูปภาพได้:", error);
    alert("เกิดข้อผิดพลาดในการโหลดไฟล์เกม โปรดตรวจสอบลิงก์รูปภาพหรือการเชื่อมต่ออินเทอร์เน็ต");
  }
}

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  camera.width = canvas.width;
  camera.height = canvas.height;
}

function setupControls() {
  // -- Joystick --
  const stick = document.getElementById("joystick-stick");
  const area = document.getElementById("joystick-area");
  const joystick = { active: false, startX: 0, startY: 0, dx: 0, dy: 0 };
  const maxDist = 40; // ระยะที่จอยสติ๊กขยับได้

  area.addEventListener("touchstart", (e) => {
    const touch = e.touches[0];
    joystick.active = true;
    joystick.startX = touch.clientX;
    joystick.startY = touch.clientY;
  }, { passive: true });

  area.addEventListener("touchmove", (e) => {
    if (!joystick.active) return;
    const touch = e.touches[0];
    const dx = touch.clientX - joystick.startX;
    const dy = touch.clientY - joystick.startY;
    const dist = Math.sqrt(dx * dx + dy * dy);
    const angle = Math.atan2(dy, dx);

    const limitedDist = Math.min(dist, maxDist);
    joystick.dx = Math.cos(angle) * limitedDist;
    joystick.dy = Math.sin(angle) * limitedDist;

    player.dx = joystick.dx / maxDist;
    player.dy = joystick.dy / maxDist;

    stick.style.left = 75 + joystick.dx + "px";
    stick.style.top = 75 + joystick.dy + "px";
  }, { passive: true });

  const resetJoystick = () => {
    joystick.active = false;
    player.dx = 0;
    player.dy = 0;
    stick.style.left = "75px";
    stick.style.top = "75px";
  };
  area.addEventListener("touchend", resetJoystick);
  area.addEventListener("touchcancel", resetJoystick);

  // -- Action Button --
  const actionButton = document.getElementById('action-button');
  actionButton.addEventListener('touchstart', e => {
    e.preventDefault();
    actionPressed = true;
    actionButton.style.background = 'rgba(255,80,80,0.9)';
  });
  actionButton.addEventListener('touchend', e => {
    e.preventDefault();
    actionPressed = false;
    actionButton.style.background = 'rgba(255,80,80,0.6)';
  });

  // -- Keyboard --
  window.addEventListener('keydown', e => {
    if (e.key === 'ArrowUp' || e.key === 'w') keys.up = true;
    if (e.key === 'ArrowDown' || e.key === 's') keys.down = true;
    if (e.key === 'ArrowLeft' || e.key === 'a') keys.left = true;
    if (e.key === 'ArrowRight' || e.key === 'd') keys.right = true;
    if (e.key === ' ') actionPressed = true;
  });
  window.addEventListener('keyup', e => {
    if (e.key === 'ArrowUp' || e.key === 'w') keys.up = false;
    if (e.key === 'ArrowDown' || e.key === 's') keys.down = false;
    if (e.key === 'ArrowLeft' || e.key === 'a') keys.left = false;
    if (e.key === 'ArrowRight' || e.key === 'd') keys.right = false;
    if (e.key === ' ') actionPressed = false;
  });
}

function update() {
  let moveX = 0;
  let moveY = 0;
  if (keys.up) moveY -= 1;
  if (keys.down) moveY += 1;
  if (keys.left) moveX -= 1;
  if (keys.right) moveX += 1;

  if (player.dx !== 0 || player.dy !== 0) {
    moveX = player.dx;
    moveY = player.dy;
  }
  
  const length = Math.sqrt(moveX * moveX + moveY * moveY);
  if (length > 0) {
    moveX = (moveX / length) * player.speed;
    moveY = (moveY / length) * player.speed;
  }

  player.x += moveX;
  player.y += moveY;

  player.x = Math.max(0, Math.min(world.width - player.width, player.x));
  player.y = Math.max(0, Math.min(world.height - player.height, player.y));

  camera.x = player.x - camera.width / 2 + player.width / 2;
  camera.y = player.y - camera.height / 2 + player.height / 2;

  camera.x = Math.max(0, Math.min(world.width - camera.width, camera.x));
  camera.y = Math.max(0, Math.min(world.height - camera.height, camera.y));

  const dx = player.x - npc.x;
  const dy = player.y - npc.y;
  const distance = Math.sqrt(dx * dx + dy * dy);

  if (actionPressed && distance < 70) {
    alert("ขอบคุณที่มาหาเรา! โลกนี้รอการช่วยเหลือจากเธออยู่!");
    actionPressed = false;
  }
}

function draw(playerImg, npcImg) {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.save();
  ctx.translate(-camera.x, -camera.y);

  if (grassPattern) {
    ctx.fillStyle = grassPattern;
    ctx.fillRect(0, 0, world.width, world.height);
  }

  ctx.drawImage(npcImg, npc.x, npc.y, npc.width, npc.height);
  ctx.drawImage(playerImg, player.x, player.y, player.width, player.height);
  
  ctx.restore();
}

// สร้างตัวแปร global เพื่อเก็บ instance ของรูปที่โหลดแล้ว
let loadedPlayerImg, loadedNpcImg;

function gameLoop() {
  update();
  // ส่งรูปที่โหลดแล้วไปวาด
  draw(loadedPlayerImg, loadedNpcImg);
  requestAnimationFrame(gameLoop);
}

// ปรับปรุงการเรียกฟังก์ชันเริ่มต้น
async function main() {
  try {
    [loadedPlayerImg, loadedNpcImg, grassImg] = await Promise.all([
      loadImage('https://i.imgur.com/MieLq23.png'), // รูป Player สำรอง
      loadImage('https://i.imgur.com/V2wNn7g.png'), // รูป NPC สำรอง
      loadImage('https://i.imgur.com/ihDJe4n.png')  // รูปพื้นหญ้า (ลิงก์เดิม)
    ]);
    
    grassPattern = ctx.createPattern(grassImg, 'repeat');
    
    setupControls();
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);
    
    gameLoop();

  } catch (error) {
    console.error("ไม่สามารถโหลดรูปภาพได้:", error);
    alert("เกิดข้อผิดพลาดในการโหลดไฟล์เกม โปรดตรวจสอบลิงก์รูปภาพหรือการเชื่อมต่ออินเทอร์เน็ต");
  }
}

main();
</script>
