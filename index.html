<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>หมากฮอต Co-op</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            height: 100%;
        }
        
        .lobby {
            text-align: center;
            max-width: 500px;
            width: 100%;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .game-board {
            display: none;
            width: 100%;
            max-width: 500px;
            aspect-ratio: 1/1;
            background-color: #e0c9a6;
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .dot {
            position: absolute;
            width: 8%;
            height: 8%;
            background-color: #333;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        
        .line {
            position: absolute;
            background-color: #333;
            transform-origin: 0 0;
        }
        
        .piece {
            position: absolute;
            width: 6%;
            height: 6%;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.3s;
            z-index: 10;
        }
        
        .piece.red {
            background-color: #e74c3c;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        
        .piece.blue {
            background-color: #3498db;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        
        .piece.selected {
            transform: translate(-50%, -50%) scale(1.2);
            box-shadow: 0 0 10px rgba(0,0,0,0.8);
        }
        
        .controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background-color: #2ecc71;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #27ae60;
        }
        
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .player-info {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .player {
            padding: 10px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            width: 48%;
            text-align: center;
        }
        
        .player.host {
            background-color: #e74c3c;
        }
        
        .player.guest {
            background-color: #3498db;
        }
        
        .status {
            margin: 10px 0;
            font-weight: bold;
        }
        
        .rules {
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .rules h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .rules ol {
            padding-left: 20px;
        }
        
        .rules li {
            margin-bottom: 5px;
        }
        
        .valid-move {
            position: absolute;
            width: 4%;
            height: 4%;
            background-color: rgba(46, 204, 113, 0.5);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 5;
        }
        
        .chat-container {
            display: none;
            width: 100%;
            max-width: 500px;
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 15px;
        }
        
        .chat-messages {
            height: 150px;
            overflow-y: auto;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }
        
        .chat-input {
            display: flex;
            gap: 10px;
        }
        
        .chat-input input {
            flex: 1;
            margin-bottom: 0;
        }
        
        .chat-input button {
            padding: 10px;
        }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <div class="container">
        <div class="lobby" id="lobby">
            <h1>หมากฮอต Co-op</h1>
            <div id="joinSection">
                <input type="text" id="roomCode" placeholder="ใส่รหัสห้อง">
                <button id="joinBtn">เข้าร่วมห้อง</button>
                <p>หรือ</p>
                <button id="createBtn">สร้างห้องใหม่</button>
            </div>
            <div id="waitingSection" style="display: none;">
                <h2>รหัสห้อง: <span id="displayRoomCode"></span></h2>
                <p>ส่งลิงค์นี้ให้เพื่อน: <span id="roomLink"></span></p>
                <div class="player-info">
                    <div class="player host" id="hostPlayer">เจ้าของห้อง: คุณ</div>
                    <div class="player guest" id="guestPlayer">ผู้เล่น 2: กำลังรอ...</div>
                </div>
                <div class="status" id="lobbyStatus"></div>
                <button id="startBtn" disabled>เริ่มเกม</button>
            </div>
        </div>
        
        <div class="game-board" id="gameBoard"></div>
        
        <div class="chat-container" id="chatContainer">
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input">
                <input type="text" id="chatInput" placeholder="พิมพ์ข้อความ...">
                <button id="sendBtn">ส่ง</button>
            </div>
        </div>
        
        <div class="rules">
            <h3>กติกาสากลหมากฮอต</h3>
            <ol>
                <li>ผู้เล่นผลัดกันเดินทีละคน โดยเริ่มจากผู้เล่นสีแดง</li>
                <li>เดินหมากไปยังจุดที่ว่างโดยเชื่อมต่อกับเส้น</li>
                <li>เมื่อสามารถสร้างแถวของหมากตัวเอง 3 ตัวเรียงกัน ให้กินหมากของคู่ต่อสู้ 1 ตัว</li>
                <li>ผู้เล่นที่กินหมากคู่ต่อสู้จนเหลือน้อยกว่า 3 ตัวหรือทำให้คู่ต่อสู้เดินไม่ได้เป็นผู้ชนะ</li>
            </ol>
        </div>
    </div>

    <script>
        // ป้องกันการเลื่อนหน้าจอ
        document.addEventListener('touchmove', function(e) {
            e.preventDefault();
        }, { passive: false });
        
        // ป้องกันการดับเบิลคลิกซูม
        document.addEventListener('dblclick', function(e) {
            e.preventDefault();
        }, { passive: false });
        
        // ตัวแปรเกม
        let isHost = false;
        let roomCode = '';
        let currentPlayer = 'red';
        let selectedPiece = null;
        let pieces = {};
        let lines = [];
        let dots = [];
        let gameStarted = false;
        let myPlayerColor = '';
        let playerName = '';
        let db = null;
        let roomRef = null;
        let chatRef = null;
        
        // องค์ประกอบ DOM
        const lobby = document.getElementById('lobby');
        const gameBoard = document.getElementById('gameBoard');
        const joinSection = document.getElementById('joinSection');
        const waitingSection = document.getElementById('waitingSection');
        const roomCodeInput = document.getElementById('roomCode');
        const displayRoomCode = document.getElementById('displayRoomCode');
        const roomLink = document.getElementById('roomLink');
        const joinBtn = document.getElementById('joinBtn');
        const createBtn = document.getElementById('createBtn');
        const startBtn = document.getElementById('startBtn');
        const hostPlayer = document.getElementById('hostPlayer');
        const guestPlayer = document.getElementById('guestPlayer');
        const lobbyStatus = document.getElementById('lobbyStatus');
        const chatContainer = document.getElementById('chatContainer');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        
        // กำหนดค่า Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDEXAMPLEEXAMPLEEXAMPLEEXAMPLE",
            authDomain: "your-project-id.firebaseapp.com",
            databaseURL: "https://your-project-id.firebaseio.com",
            projectId: "your-project-id",
            storageBucket: "your-project-id.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:EXAMPLEEXAMPLEEXAMPLE"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
        
        // สร้างห้องใหม่
        createBtn.addEventListener('click', function() {
            playerName = prompt("กรุณาใส่ชื่อของคุณ:");
            if (!playerName) playerName = "ผู้เล่น 1";
            
            isHost = true;
            myPlayerColor = 'red';
            roomCode = generateRoomCode();
            displayRoomCode.textContent = roomCode;
            roomLink.textContent = window.location.href.split('?')[0] + '?room=' + roomCode;
            
            joinSection.style.display = 'none';
            waitingSection.style.display = 'block';
            startBtn.disabled = true;
            
            // สร้างห้องใน Firebase
            roomRef = db.ref('rooms/' + roomCode);
            
            // ตั้งค่าห้องเริ่มต้น
            roomRef.set({
                host: {
                    name: playerName,
                    ready: false
                },
                guest: null,
                gameState: null,
                status: 'waiting'
            });
            
            // ติดตามการเปลี่ยนแปลงในห้อง
            roomRef.on('value', (snapshot) => {
                const roomData = snapshot.val();
                if (!roomData) return;
                
                if (roomData.guest) {
                    guestPlayer.textContent = `ผู้เล่น 2: ${roomData.guest.name || 'เพื่อน'} (สีน้ำเงิน)`;
                    startBtn.disabled = !roomData.host.ready || !roomData.guest.ready;
                } else {
                    guestPlayer.textContent = 'ผู้เล่น 2: กำลังรอ...';
                    startBtn.disabled = true;
                }
                
                if (roomData.status === 'playing') {
                    startGame(roomData.gameState);
                }
            });
            
            // ตั้งค่าห้องแชท
            setupChat();
        });
        
        // เข้าร่วมห้อง
        joinBtn.addEventListener('click', function() {
            playerName = prompt("กรุณาใส่ชื่อของคุณ:");
            if (!playerName) playerName = "ผู้เล่น 2";
            
            roomCode = roomCodeInput.value.trim();
            if (roomCode.length === 0) {
                alert('กรุณากรอกรหัสห้อง');
                return;
            }
            
            isHost = false;
            myPlayerColor = 'blue';
            displayRoomCode.textContent = roomCode;
            
            joinSection.style.display = 'none';
            waitingSection.style.display = 'block';
            startBtn.style.display = 'none';
            
            // เชื่อมต่อกับห้องใน Firebase
            roomRef = db.ref('rooms/' + roomCode);
            
            // ตรวจสอบว่าห้องมีอยู่หรือไม่
            roomRef.once('value').then((snapshot) => {
                if (!snapshot.exists()) {
                    alert('ไม่พบห้องที่ระบุ');
                    joinSection.style.display = 'block';
                    waitingSection.style.display = 'none';
                    return;
                }
                
                const roomData = snapshot.val();
                hostPlayer.textContent = `เจ้าของห้อง: ${roomData.host.name || 'เพื่อน'} (สีแดง)`;
                
                // เข้าร่วมห้อง
                roomRef.update({
                    guest: {
                        name: playerName,
                        ready: true
                    }
                });
                
                // ติดตามการเปลี่ยนแปลงในห้อง
                roomRef.on('value', (snapshot) => {
                    const roomData = snapshot.val();
                    if (!roomData) return;
                    
                    if (roomData.status === 'playing') {
                        startGame(roomData.gameState);
                    }
                });
                
                // ตั้งค่าห้องแชท
                setupChat();
            });
        });
        
        // เริ่มเกม (เจ้าของห้องเท่านั้นที่กดได้)
        startBtn.addEventListener('click', function() {
            if (!isHost) return;
            
            // สร้างสถานะเกมเริ่มต้น
            const gameState = initializeGameState();
            
            // อัปเดตสถานะห้องเป็นเล่นเกม
            roomRef.update({
                status: 'playing',
                gameState: gameState
            });
        });
        
        // ตั้งค่าห้องแชท
        function setupChat() {
            chatContainer.style.display = 'block';
            chatRef = db.ref('rooms/' + roomCode + '/chat');
            
            // แสดงข้อความแชท
            chatRef.on('child_added', (snapshot) => {
                const message = snapshot.val();
                displayMessage(message);
            });
            
            // ส่งข้อความ
            sendBtn.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
        }
        
        // ส่งข้อความแชท
        function sendMessage() {
            const text = chatInput.value.trim();
            if (text === '') return;
            
            const message = {
                sender: playerName,
                text: text,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            chatRef.push(message);
            chatInput.value = '';
        }
        
        // แสดงข้อความแชท
        function displayMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.innerHTML = `<strong>${message.sender}:</strong> ${message.text}`;
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // เริ่มเกม
        function startGame(initialGameState) {
            lobby.style.display = 'none';
            gameBoard.style.display = 'block';
            gameStarted = true;
            
            initializeBoard(initialGameState);
            
            // ติดตามการเปลี่ยนแปลงในเกม
            roomRef.child('gameState').on('value', (snapshot) => {
                const gameState = snapshot.val();
                if (!gameState) return;
                
                updateGameState(gameState);
            });
        }
        
        // สร้างรหัสห้องแบบสุ่ม
        function generateRoomCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let result = '';
            for (let i = 0; i < 5; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        // เริ่มต้นสถานะเกม
        function initializeGameState() {
            return {
                currentPlayer: 'red',
                pieces: {
                    '0,3': { row: 0, col: 3, color: 'red' },
                    '3,0': { row: 3, col: 0, color: 'blue' },
                    '3,6': { row: 3, col: 6, color: 'blue' },
                    '6,3': { row: 6, col: 3, color: 'red' }
                },
                selectedPiece: null,
                validMoves: [],
                status: 'playing'
            };
        }
        
        // เริ่มต้นกระดานเกม
        function initializeBoard(initialGameState) {
            gameBoard.innerHTML = '';
            dots = [];
            lines = [];
            pieces = {};
            
            const boardSize = gameBoard.offsetWidth;
            const spacing = boardSize / 8;
            
            // สร้างจุด
            for (let row = 0; row < 7; row++) {
                for (let col = 0; col < 7; col++) {
                    if ((row < 2 || row > 4) && (col < 2 || col > 4)) continue;
                    
                    const dot = document.createElement('div');
                    dot.className = 'dot';
                    dot.style.left = `${col * spacing + spacing}px`;
                    dot.style.top = `${row * spacing + spacing}px`;
                    dot.dataset.row = row;
                    dot.dataset.col = col;
                    gameBoard.appendChild(dot);
                    dots.push({row, col});
                }
            }
            
            // สร้างเส้นเชื่อม
            createConnections();
            
            // อัปเดตสถานะเกมเริ่มต้น
            updateGameState(initialGameState);
        }
        
        // สร้างเส้นเชื่อมระหว่างจุด
        function createConnections() {
            const boardSize = gameBoard.offsetWidth;
            const spacing = boardSize / 8;
            
            dots.forEach(dot1 => {
                dots.forEach(dot2 => {
                    // เชื่อมเฉพาะจุดที่อยู่ติดกันในแนวตั้งหรือแนวนอน
                    if ((Math.abs(dot1.row - dot2.row) === 1 && dot1.col === dot2.col) || 
                        (Math.abs(dot1.col - dot2.col) === 1 && dot1.row === dot2.row)) {
                        
                        const x1 = dot1.col * spacing + spacing;
                        const y1 = dot1.row * spacing + spacing;
                        const x2 = dot2.col * spacing + spacing;
                        const y2 = dot2.row * spacing + spacing;
                        
                        const length = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
                        const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
                        
                        const line = document.createElement('div');
                        line.className = 'line';
                        line.style.width = `${length}px`;
                        line.style.height = '2px';
                        line.style.left = `${x1}px`;
                        line.style.top = `${y1}px`;
                        line.style.transform = `rotate(${angle}deg)`;
                        line.dataset.from = `${dot1.row},${dot1.col}`;
                        line.dataset.to = `${dot2.row},${dot2.col}`;
                        gameBoard.appendChild(line);
                        
                        lines.push({
                            from: `${dot1.row},${dot1.col}`,
                            to: `${dot2.row},${dot2.col}`,
                            element: line
                        });
                    }
                });
            });
        }
        
        // อัปเดตสถานะเกมจาก Firebase
        function updateGameState(gameState) {
            currentPlayer = gameState.currentPlayer;
            selectedPiece = gameState.selectedPiece;
            
            // ลบหมากทั้งหมด
            document.querySelectorAll('.piece').forEach(p => p.remove());
            document.querySelectorAll('.valid-move').forEach(v => v.remove());
            pieces = {};
            
            // เพิ่มหมากตามสถานะปัจจุบัน
            for (const [key, piece] of Object.entries(gameState.pieces)) {
                addPiece(piece.row, piece.col, piece.color);
            }
            
            // แสดงการเคลื่อนที่ที่ถูกต้อง
            if (gameState.validMoves) {
                gameState.validMoves.forEach(move => {
                    const validMove = document.createElement('div');
                    validMove.className = 'valid-move';
                    validMove.style.left = `${move.col * (gameBoard.offsetWidth / 7) + (gameBoard.offsetWidth / 14)}px`;
                    validMove.style.top = `${move.row * (gameBoard.offsetWidth / 7) + (gameBoard.offsetWidth / 14)}px`;
                    validMove.dataset.row = move.row;
                    validMove.dataset.col = move.col;
                    gameBoard.appendChild(validMove);
                });
            }
            
            // ไฮไลต์หมากที่เลือก
            if (selectedPiece) {
                const pieceElement = document.querySelector(`.piece[data-row="${selectedPiece.row}"][data-col="${selectedPiece.col}"]`);
                if (pieceElement) {
                    pieceElement.classList.add('selected');
                }
            }
        }
        
        // เพิ่มหมากบนกระดาน
        function addPiece(row, col, color) {
            const boardSize = gameBoard.offsetWidth;
            const spacing = boardSize / 7;
            
            const piece = document.createElement('div');
            piece.className = `piece ${color}`;
            piece.style.left = `${col * spacing + spacing/2}px`;
            piece.style.top = `${row * spacing + spacing/2}px`;
            piece.dataset.row = row;
            piece.dataset.col = col;
            piece.dataset.color = color;
            
            // เพิ่ม Event Listener สำหรับการคลิก (เฉพาะเมื่อเป็นตาของผู้เล่น)
            if (color === myPlayerColor && currentPlayer === myPlayerColor) {
                piece.addEventListener('click', handlePieceClick);
            }
            
            gameBoard.appendChild(piece);
            
            pieces[`${row},${col}`] = {row, col, color, element: piece};
            return piece;
        }
        
        // จัดการเมื่อคลิกที่หมาก
        function handlePieceClick(e) {
            if (!gameStarted || currentPlayer !== myPlayerColor) return;
            
            const piece = e.target;
            const row = parseInt(piece.dataset.row);
            const col = parseInt(piece.dataset.col);
            
            // อัปเดตสถานะเกมใน Firebase
            roomRef.child('gameState').update({
                selectedPiece: { row, col }
            });
            
            // คำนวณการเคลื่อนที่ที่ถูกต้อง
            const validMoves = calculateValidMoves(row, col);
            
            // อัปเดตการเคลื่อนที่ที่ถูกต้องใน Firebase
            roomRef.child('gameState').update({
                validMoves: validMoves
            });
        }
        
        // คำนวณการเคลื่อนที่ที่ถูกต้อง
        function calculateValidMoves(row, col) {
            const validMoves = [];
            const piece = pieces[`${row},${col}`];
            if (!piece) return validMoves;
            
            // ตรวจสอบการเชื่อมต่อทั้งหมดจากจุดนี้
            const connections = lines.filter(line => 
                line.from === `${row},${col}` || line.to === `${row},${col}`
            );
            
            // สำหรับแต่ละการเชื่อมต่อ ตรวจสอบว่าจุดปลายทางว่างหรือไม่
            connections.forEach(connection => {
                const [toRow, toCol] = (connection.from === `${row},${col}`) ? 
                    connection.to.split(',').map(Number) : 
                    connection.from.split(',').map(Number);
                
                if (!pieces[`${toRow},${toCol}`]) {
                    validMoves.push({ row: toRow, col: toCol });
                }
            });
            
            return validMoves;
        }
        
        // จัดการเมื่อคลิกที่กระดาน (สำหรับการเคลื่อนหมาก)
        gameBoard.addEventListener('click', function(e) {
            if (!gameStarted || currentPlayer !== myPlayerColor || !selectedPiece) return;
            
            const target = e.target;
            if (target.classList.contains('valid-move')) {
                const toRow = parseInt(target.dataset.row);
                const toCol = parseInt(target.dataset.col);
                
                // สร้างสถานะเกมใหม่หลังการเคลื่อนไหว
                const newPieces = {...pieces};
                const fromKey = `${selectedPiece.row},${selectedPiece.col}`;
                const toKey = `${toRow},${toCol}`;
                
                // ย้ายหมาก
                newPieces[toKey] = {
                    row: toRow,
                    col: toCol,
                    color: newPieces[fromKey].color
                };
                delete newPieces[fromKey];
                
                // สลับผู้เล่น
                const newCurrentPlayer = currentPlayer === 'red' ? 'blue' : 'red';
                
                // อัปเดตสถานะเกมใน Firebase
                roomRef.child('gameState').set({
                    currentPlayer: newCurrentPlayer,
                    pieces: newPieces,
                    selectedPiece: null,
                    validMoves: [],
                    status: 'playing'
                });
            }
        });
        
        // ในความเป็นจริงควรมีโค้ดสำหรับตรวจสอบการชนะ
        
        // ตรวจสอบว่ามีรหัสห้องใน URL หรือไม่ (สำหรับผู้เล่นที่เข้าร่วมผ่านลิงค์)
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const roomParam = urlParams.get('room');
            
            if (roomParam) {
                roomCodeInput.value = roomParam;
            }
        });
    </script>
</body>
</html>