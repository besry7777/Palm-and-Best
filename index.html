<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ตำนานแห่งอัญมณีที่ถูกลืม</title>
  <style>
    /* สไตล์พื้นฐาน */
    body, html {
      margin: 0; padding: 0;
      overflow: hidden;
      background: #000;
      height: 100%; width: 100%;
      display: flex; justify-content: center; align-items: center;
      touch-action: none;
      font-family: 'Courier New', monospace;
    }
    canvas {
      display: block;
      image-rendering: pixelated;
    }

    /* ป้องกันการซูมเมื่อ Double Tap */
    * {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      touch-action: manipulation;
    }

    /* ปุ่มควบคุมมือถือ */
    .mobile-controls {
      position: fixed;
      bottom: 20px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-between;
      pointer-events: none;
      z-index: 50;
    }

    /* จอยสติ๊ก */
    #joystick-area {
      position: relative;
      width: 150px;
      height: 150px;
      margin-left: 30px;
      pointer-events: auto;
    }

    #joystick-bg, #joystick-stick {
      position: absolute;
      border-radius: 50%;
      transform: translate(-50%, -50%);
    }

    #joystick-bg {
      width: 120px;
      height: 120px;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.3);
      left: 75px; top: 75px;
    }

    #joystick-stick {
      width: 60px;
      height: 60px;
      background: rgba(255, 255, 255, 0.4);
      border: 2px solid rgba(0, 0, 0, 0.3);
      left: 75px; top: 75px;
      transition: all 0.1s linear;
    }

    /* ปุ่ม Action */
    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-right: 30px;
      pointer-events: auto;
    }

    .action-button {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 18px;
      color: white;
      font-weight: bold;
      text-shadow: 1px 1px 2px #000;
    }

    #action-btn {
      background: rgba(255, 80, 80, 0.6);
      border: 2px solid rgba(255, 0, 0, 0.8);
    }

    #menu-btn {
      background: rgba(80, 80, 255, 0.6);
      border: 2px solid rgba(0, 0, 255, 0.8);
    }

    #jump-btn {
      background: rgba(80, 255, 80, 0.6);
      border: 2px solid rgba(0, 255, 0, 0.8);
    }

    /* กล่องข้อความ */
    #dialog-box {
      position: fixed;
      bottom: 20px;
      left: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      border: 4px solid #4a2c12;
      border-radius: 10px;
      padding: 15px;
      color: white;
      display: none;
      z-index: 100;
    }

    #dialog-text {
      margin-bottom: 15px;
      line-height: 1.5;
    }

    #dialog-options {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .dialog-option {
      background: #4a2c12;
      border: 2px solid #6d4a2a;
      border-radius: 5px;
      padding: 8px;
      cursor: pointer;
    }

    .dialog-option:hover {
      background: #6d4a2a;
    }

    /* เมนูเกม */
    #game-menu {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 200;
      display: none;
    }

    .menu-title {
      color: #f8d030;
      font-size: 2.5rem;
      margin-bottom: 2rem;
      text-shadow: 2px 2px 0 #b88a00;
    }

    .menu-button {
      background: #4a2c12;
      border: 4px solid #6d4a2a;
      border-radius: 10px;
      color: white;
      padding: 15px 30px;
      margin: 10px;
      font-size: 1.2rem;
      cursor: pointer;
      min-width: 200px;
      text-align: center;
    }

    .menu-button:hover {
      background: #6d4a2a;
    }

    /* สถานะผู้เล่น */
    #player-status {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.6);
      border: 3px solid #4a2c12;
      border-radius: 8px;
      padding: 8px;
      color: white;
      font-size: 14px;
    }

    .status-bar {
      height: 10px;
      background: #333;
      border-radius: 5px;
      margin-top: 3px;
      overflow: hidden;
    }

    .health-bar {
      height: 100%;
      background: #ff4444;
      width: 100%;
    }

    .energy-bar {
      height: 100%;
      background: #44aaff;
      width: 100%;
    }

    /* เอฟเฟกต์เปลี่ยนฉาก */
    .scene-transition {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      z-index: 300;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s ease-in-out;
    }
  </style>
</head>
<body>

<canvas id="gameCanvas"></canvas>

<!-- ระบบควบคุมมือถือ -->
<div class="mobile-controls">
  <div id="joystick-area">
    <div id="joystick-bg"></div>
    <div id="joystick-stick"></div>
  </div>
  
  <div class="action-buttons">
    <div class="action-button" id="jump-btn">กระโดด</div>
    <div class="action-button" id="action-btn">คุย</div>
    <div class="action-button" id="menu-btn">เมนู</div>
  </div>
</div>

<!-- กล่องข้อความ -->
<div id="dialog-box">
  <div id="dialog-text"></div>
  <div id="dialog-options"></div>
</div>

<!-- เมนูเกม -->
<div id="game-menu">
  <div class="menu-title">ตำนานแห่งอัญมณีที่ถูกลืม</div>
  <div class="menu-button" id="continue-btn">เล่นต่อ</div>
  <div class="menu-button" id="new-game-btn">เกมใหม่</div>
  <div class="menu-button" id="settings-btn">ตั้งค่า</div>
  <div class="menu-button" id="quit-btn">ออกจากเกม</div>
</div>

<!-- สถานะผู้เล่น -->
<div id="player-status">
  <div>ชื่อ: <span id="player-name">นักผจญภัย</span></div>
  <div>HP: <span id="hp-text">100/100</span></div>
  <div class="status-bar"><div class="health-bar" id="health-bar"></div></div>
  <div>พลังงาน: <span id="energy-text">50/50</span></div>
  <div class="status-bar"><div class="energy-bar" id="energy-bar"></div></div>
</div>

<!-- เอฟเฟกต์เปลี่ยนฉาก -->
<div class="scene-transition" id="scene-transition"></div>

<script>
// Canvas & Context
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// ขนาดโลกเกม
const TILE_SIZE = 32;
const world = {
  width: 60 * TILE_SIZE,  // 1920px
  height: 50 * TILE_SIZE  // 1600px
};

// ระบบสุ่ม
function randomInt(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

// ประเภทฉาก
const SCENES = {
  FOREST: 'forest',
  TOWN: 'town',
  CAVE: 'cave'
};

// สร้างแผนที่ด้วย Perlin Noise
function generateMap(sceneType, width, height) {
  const map = [];
  const noise = new PerlinNoise();
  
  for (let y = 0; y < height; y++) {
    const row = [];
    for (let x = 0; x < width; x++) {
      // สร้างค่าความสูงจาก noise
      const elevation = noise.get(x * 0.1, y * 0.1);
      
      if (sceneType === SCENES.FOREST) {
        // ฉากป่า
        if (elevation > 0.6) {
          // ภูเขา
          row.push({ type: 'mountain', color: '#8B8B8B', walkable: false });
        } else if (elevation > 0.4) {
          // หิน
          row.push({ type: 'rock', color: '#A0A0A0', walkable: true });
        } else if (elevation > 0.2) {
          // ดิน
          row.push({ type: 'dirt', color: '#8B4513', walkable: true });
        } else if (elevation > -0.2) {
          // หญ้า
          row.push({ type: 'grass', color: '#2E8B57', walkable: true });
        } else if (elevation > -0.4) {
          // ทราย
          row.push({ type: 'sand', color: '#F4A460', walkable: true });
        } else {
          // น้ำ
          row.push({ type: 'water', color: '#1E90FF', walkable: false });
        }
      } else if (sceneType === SCENES.TOWN) {
        // ฉากเมือง
        if (elevation > 0.6) {
          // อาคาร
          row.push({ type: 'building', color: '#B22222', walkable: false });
        } else if (elevation > 0.4) {
          // ถนนหิน
          row.push({ type: 'stone_road', color: '#808080', walkable: true });
        } else if (elevation > 0.2) {
          // ถนนดิน
          row.push({ type: 'dirt_road', color: '#8B4513', walkable: true });
        } else if (elevation > -0.2) {
          // พื้นหญ้าเมือง
          row.push({ type: 'town_grass', color: '#7CFC00', walkable: true });
        } else if (elevation > -0.4) {
          // แผ่นไม้
          row.push({ type: 'wood_plank', color: '#DEB887', walkable: true });
        } else {
          // น้ำพุ
          row.push({ type: 'fountain', color: '#87CEEB', walkable: false });
        }
      } else if (sceneType === SCENES.CAVE) {
        // ฉากถ้ำ
        if (elevation > 0.6) {
          // หินยักษ์
          row.push({ type: 'big_rock', color: '#696969', walkable: false });
        } else if (elevation > 0.4) {
          // หิน
          row.push({ type: 'rock', color: '#808080', walkable: true });
        } else if (elevation > 0.2) {
          // ดินถ้ำ
          row.push({ type: 'cave_dirt', color: '#654321', walkable: true });
        } else if (elevation > -0.2) {
          // หินระยิบระยับ
          row.push({ type: 'shiny_rock', color: '#DAA520', walkable: true });
        } else if (elevation > -0.4) {
          // น้ำใต้ดิน
          row.push({ type: 'underground_water', color: '#4169E1', walkable: false });
        } else {
          // คริสตัล
          row.push({ type: 'crystal', color: '#9370DB', walkable: false });
        }
      }
    }
    map.push(row);
  }
  
  // เพิ่มรายละเอียดให้แผนที่
  addFeatures(map, sceneType);
  
  return map;
}

// เพิ่มรายละเอียดให้แผนที่ (ต้นไม้, ทางเดิน, ฯลฯ)
function addFeatures(map, sceneType) {
  const width = map[0].length;
  const height = map.length;
  
  if (sceneType === SCENES.FOREST) {
    // เพิ่มต้นไม้ในพื้นที่หญ้า
    for (let y = 0; y < height; y++) {
      for (let x = 0; x < width; x++) {
        if (map[y][x].type === 'grass' && Math.random() < 0.05) {
          map[y][x].feature = 'tree';
          map[y][x].featureColor = '#228B22';
        }
      }
    }
    
    // สร้างทางเดินแบบสุ่ม
    createPath(map, width / 2, height / 2, 100);
  }
  else if (sceneType === SCENES.TOWN) {
    // เพิ่มบ้านและ NPC ในเมือง
    for (let y = 0; y < height; y++) {
      for (let x = 0; x < width; x++) {
        if (map[y][x].type === 'building' && Math.random() < 0.2) {
          map[y][x].feature = 'house';
        }
      }
    }
    
    // สร้างถนนหลัก
    createTownRoads(map);
  }
  else if (sceneType === SCENES.CAVE) {
    // เพิ่มคริสตัลในถ้ำ
    for (let y = 0; y < height; y++) {
      for (let x = 0; x < width; x++) {
        if (map[y][x].type === 'shiny_rock' && Math.random() < 0.1) {
          map[y][x].feature = 'crystal_cluster';
        }
      }
    }
  }
}

// สร้างทางเดินแบบสุ่ม
function createPath(map, startX, startY, steps) {
  let x = startX;
  let y = startY;
  
  for (let i = 0; i < steps; i++) {
    // ตรวจสอบขอบเขต
    x = Math.max(1, Math.min(map[0].length - 2, x));
    y = Math.max(1, Math.min(map.length - 2, y));
    
    // เปลี่ยนพื้นที่เป็นทางเดิน
    for (let dy = -1; dy <= 1; dy++) {
      for (let dx = -1; dx <= 1; dx++) {
        if (map[y + dy][x + dx].walkable !== false) {
          map[y + dy][x + dx].type = 'path';
          map[y + dy][x + dx].color = '#D2B48C';
        }
      }
    }
    
    // เคลื่อนที่แบบสุ่ม
    const dir = randomInt(0, 3);
    if (dir === 0) y--;
    else if (dir === 1) y++;
    else if (dir === 2) x--;
    else x++;
  }
}

// สร้างถนนในเมือง
function createTownRoads(map) {
  const width = map[0].length;
  const height = map.length;
  
  // ถนนแนวนอน
  for (let x = 0; x < width; x++) {
    for (let y = height/2 - 2; y <= height/2 + 2; y++) {
      if (y >= 0 && y < height) {
        map[y][x].type = 'stone_road';
        map[y][x].color = '#808080';
      }
    }
  }
  
  // ถนนแนวตั้ง
  for (let y = 0; y < height; y++) {
    for (let x = width/2 - 2; x <= width/2 + 2; x++) {
      if (x >= 0 && x < width) {
        map[y][x].type = 'stone_road';
        map[y][x].color = '#808080';
      }
    }
  }
}

// ตัวละครหลัก
const player = {
  x: world.width / 2,
  y: world.height / 2,
  width: 24,
  height: 32,
  speed: 3,
  dx: 0,
  dy: 0,
  name: "นักผจญภัย",
  hp: 100,
  maxHp: 100,
  energy: 50,
  maxEnergy: 50,
  direction: 'down', // 'up', 'down', 'left', 'right'
  moving: false,
  jumping: false,
  jumpHeight: 0,
  maxJumpHeight: 20,
  skinColor: '#FFDBAC',
  hairColor: '#8B4513',
  shirtColor: '#4169E1',
  pantsColor: '#2E8B57'
};

// NPCs
const npcs = {
  forest: [
    {
      id: 1,
      x: world.width / 2 + 150,
      y: world.height / 2 - 50,
      width: 24,
      height: 32,
      name: "พ่อค้า",
      skinColor: '#D2B48C',
      hairColor: '#000000',
      shirtColor: '#FF6347',
      pantsColor: '#8B4513',
      dialogues: [
        {
          id: 1,
          text: "สวัสดีนักผจญภัย! ต้องการซื้ออะไรไหม?",
          options: [
            { text: "แสดงสินค้า", nextDialog: 2 },
            { text: "ไม่เป็นไร ขอบคุณ", nextDialog: -1 }
          ]
        },
        {
          id: 2,
          text: "นี่คือสินค้าของฉัน:",
          options: [
            { text: "ซื้อดาบ (50 เงิน)", action: "buy", item: "sword", cost: 50, nextDialog: 3 },
            { text: "ซื้อเกราะ (80 เงิน)", action: "buy", item: "armor", cost: 80, nextDialog: 3 },
            { text: "ไม่สนใจ", nextDialog: -1 }
          ]
        },
        {
          id: 3,
          text: "ขอบคุณสำหรับการซื้อ!",
          options: [
            { text: "ลาก่อน", nextDialog: -1 }
          ]
        }
      ]
    },
    {
      id: 2,
      x: world.width / 2 - 200,
      y: world.height / 2 + 100,
      width: 24,
      height: 32,
      name: "นักบวช",
      skinColor: '#FFDBAC',
      hairColor: '#FFFFFF',
      shirtColor: '#9370DB',
      pantsColor: '#4B0082',
      dialogues: [
        {
          id: 1,
          text: "สวัสดีลูก โลกนี้กำลังตกอยู่ในอันตรายจากความมืด...",
          options: [
            { text: "เกิดอะไรขึ้น?", nextDialog: 2 },
            { text: "ฉันไม่สนใจ", nextDialog: -1 }
          ]
        },
        {
          id: 2,
          text: "อัญมณีศักดิ์สิทธิ์ที่ปกป้องโลกได้หายไป...",
          options: [
            { text: "ฉันจะช่วยหา!", nextDialog: 3, quest: "find_gem" },
            { text: "นั่นไม่ใช่ปัญหาของฉัน", nextDialog: -1 }
          ]
        },
        {
          id: 3,
          text: "ขอบคุณลูก ขอให้พระเจ้าคุ้มครองคุณ",
          options: [
            { text: "ลาก่อน", nextDialog: -1 }
          ]
        }
      ]
    }
  ],
  town: [
    {
      id: 3,
      x: world.width / 2 + 100,
      y: world.height / 2 - 100,
      width: 24,
      height: 32,
      name: "นายกเทศมนตรี",
      skinColor: '#FFDBAC',
      hairColor: '#A9A9A9',
      shirtColor: '#FFD700',
      pantsColor: '#000000',
      dialogues: [
        {
          id: 1,
          text: "ยินดีต้อนรับสู่เมืองของเรา!",
          options: [
            { text: "เมืองนี้สวยมาก", nextDialog: 2 },
            { text: "ฉันกำลังรีบ", nextDialog: -1 }
          ]
        },
        {
          id: 2,
          text: "ขอบคุณ! เราพยายามทำให้เมืองน่าอยู่",
          options: [
            { text: "มีอะไรให้ช่วยไหม?", nextDialog: 3 },
            { text: "ลาก่อน", nextDialog: -1 }
          ]
        },
        {
          id: 3,
          text: "มีปัญหากับโจรป่ากลุ่มหนึ่ง...",
          options: [
            { text: "ฉันจะจัดการพวกเขา", nextDialog: 4, quest: "defeat_bandits" },
            { text: "ไม่สนใจ", nextDialog: -1 }
          ]
        },
        {
          id: 4,
          text: "ขอบคุณมาก! เราจะให้รางวัลคุณ",
          options: [
            { text: "ลาก่อน", nextDialog: -1 }
          ]
        }
      ]
    },
    {
      id: 4,
      x: world.width / 2 - 150,
      y: world.height / 2 + 50,
      width: 24,
      height: 32,
      name: "พ่อค้าเครื่องประดับ",
      skinColor: '#D2B48C',
      hairColor: '#000000',
      shirtColor: '#FF0000',
      pantsColor: '#0000FF',
      dialogues: [
        {
          id: 1,
          text: "สวัสดี! ต้องการซื้อเครื่องประดับไหม?",
          options: [
            { text: "มีอะไรบ้าง?", nextDialog: 2 },
            { text: "ไม่สนใจ", nextDialog: -1 }
          ]
        },
        {
          id: 2,
          text: "ฉันมีแหวนและสร้อยคอที่สวยงาม",
          options: [
            { text: "ซื้อแหวน (100 เงิน)", action: "buy", item: "ring", cost: 100, nextDialog: 3 },
            { text: "ซื้อสร้อยคอ (150 เงิน)", action: "buy", item: "necklace", cost: 150, nextDialog: 3 },
            { text: "ไม่สนใจ", nextDialog: -1 }
          ]
        },
        {
          id: 3,
          text: "ขอบคุณสำหรับการซื้อ!",
          options: [
            { text: "ลาก่อน", nextDialog: -1 }
          ]
        }
      ]
    }
  ],
  cave: [
    {
      id: 5,
      x: world.width / 2,
      y: world.height / 2 - 200,
      width: 24,
      height: 32,
      name: "นักสำรวจ",
      skinColor: '#FFDBAC',
      hairColor: '#8B4513',
      shirtColor: '#808080',
      pantsColor: '#696969',
      dialogues: [
        {
          id: 1,
          text: "ระวังในถ้ำนี้! มีอันตรายมากมาย",
          options: [
            { text: "มีอะไรบ้าง?", nextDialog: 2 },
            { text: "ฉันแข็งแกร่งพอ", nextDialog: -1 }
          ]
        },
        {
          id: 2,
          text: "มีสัตว์ประหลาดและกับดักมากมาย",
          options: [
            { text: "ขอบคุณที่เตือน", nextDialog: 3 },
            { text: "ฉันไม่กลัว", nextDialog: -1 }
          ]
        },
        {
          id: 3,
          text: "ถ้าคุณพบอัญมณีลึกลับ โปรดนำมาให้ฉันดู",
          options: [
            { text: "ได้เลย", nextDialog: -1, quest: "find_mystery_gem" },
            { text: "ไม่สัญญา", nextDialog: -1 }
          ]
        }
      ]
    }
  ]
};

// กล้อง
const camera = {
  x: 0,
  y: 0,
  width: window.innerWidth,
  height: window.innerHeight
};

// การควบคุม
const keys = { up: false, down: false, left: false, right: false, jump: false };
let actionPressed = false;
let menuPressed = false;

// สถานะเกม
const gameState = {
  paused: false,
  currentDialog: null,
  currentNpc: null,
  inventory: [],
  money: 100,
  quests: [],
  currentScene: SCENES.FOREST,
  transition: false
};

// แผนที่เกม
let gameMap = [];

// Perlin Noise สำหรับสร้างแผนที่
class PerlinNoise {
  constructor() {
    this.gradients = {};
    this.memory = {};
  }

  rand_vect() {
    const theta = Math.random() * 2 * Math.PI;
    return { x: Math.cos(theta), y: Math.sin(theta) };
  }

  dot_prod_grid(x, y, vx, vy) {
    let g_vect;
    const d_vect = { x: x - vx, y: y - vy };
    if (this.gradients[[vx, vy]]) {
      g_vect = this.gradients[[vx, vy]];
    } else {
      g_vect = this.rand_vect();
      this.gradients[[vx, vy]] = g_vect;
    }
    return d_vect.x * g_vect.x + d_vect.y * g_vect.y;
  }

  smootherstep(x) {
    return 6 * x ** 5 - 15 * x ** 4 + 10 * x ** 3;
  }

  interp(x, a, b) {
    return a + this.smootherstep(x) * (b - a);
  }

  get(x, y) {
    if (this.memory[[x, y]]) {
      return this.memory[[x, y]];
    }
    
    const xf = Math.floor(x);
    const yf = Math.floor(y);
    
    // ค่า noise ที่ 4 มุม
    const tl = this.dot_prod_grid(x, y, xf, yf);
    const tr = this.dot_prod_grid(x, y, xf + 1, yf);
    const bl = this.dot_prod_grid(x, y, xf, yf + 1);
    const br = this.dot_prod_grid(x, y, xf + 1, yf + 1);
    
    // Interpolate
    const xt = this.interp(x - xf, tl, tr);
    const xb = this.interp(x - xf, bl, br);
    const v = this.interp(y - yf, xt, xb);
    
    this.memory[[x, y]] = v;
    return v;
  }
}

// วาดตัวละครแบบพิกเซล (ปรับปรุงแล้ว)
function drawPixelCharacter(x, y, width, height, character, jumpHeight = 0) {
  const jumpOffset = jumpHeight > 0 ? -jumpHeight : 0;
  const yPos = y + jumpOffset;
  
  // ศีรษะ
  ctx.fillStyle = character.skinColor;
  ctx.fillRect(x + width/4, yPos - 8, width/2, 8);
  
  // ผม
  ctx.fillStyle = character.hairColor;
  if (character.direction === 'left') {
    ctx.fillRect(x + width/4 - 2, yPos - 8, width/2 + 4, 4);
  } else if (character.direction === 'right') {
    ctx.fillRect(x + width/4 - 2, yPos - 8, width/2 + 4, 4);
  } else {
    ctx.fillRect(x + width/4, yPos - 10, width/2, 10);
  }
  
  // ตัว
  ctx.fillStyle = character.shirtColor;
  ctx.fillRect(x, yPos, width, height - 8);
  
  // กางเกง
  ctx.fillStyle = character.pantsColor;
  ctx.fillRect(x, yPos + height - 12, width, 4);
  
  // ตา (กระพริบเมื่อเคลื่อนที่)
  const eyeOffset = character.moving ? Math.floor(Date.now() / 200) % 2 : 0;
  ctx.fillStyle = '#000';
  if (character.direction === 'left' || character.direction === 'right') {
    ctx.fillRect(x + width/4 + eyeOffset, yPos - 6, 2, 2);
    ctx.fillRect(x + 3*width/4 - eyeOffset, yPos - 6, 2, 2);
  } else {
    ctx.fillRect(x + width/4, yPos - 6 + eyeOffset, 2, 2);
    ctx.fillRect(x + 3*width/4, yPos - 6 + eyeOffset, 2, 2);
  }
  
  // ปาก
  if (character.direction === 'down') {
    ctx.fillRect(x + width/2 - 2, yPos - 4, 4, 1);
  } else {
    ctx.fillRect(x + width/2 - 2, yPos - 4, 4, 1);
  }
  
  // แขนและขา
  const limbOffset = character.moving ? Math.sin(Date.now() / 200) * 2 : 0;
  
  if (character.direction === 'left') {
    // แขนซ้าย (ด้านหน้า)
    ctx.fillStyle = character.shirtColor;
    ctx.fillRect(x - 4, yPos + 8, 4, 8);
    // แขนขวา (ด้านหลัง)
    ctx.fillRect(x + width, yPos + 8, 4, 4);
    // ขา
    ctx.fillStyle = character.pantsColor;
    ctx.fillRect(x, yPos + height - 8, 8, 8);
    ctx.fillRect(x + width - 8, yPos + height - 8, 8, 8);
  } 
  else if (character.direction === 'right') {
    // แขนขวา (ด้านหน้า)
    ctx.fillStyle = character.shirtColor;
    ctx.fillRect(x + width, yPos + 8, 4, 8);
    // แขนซ้าย (ด้านหลัง)
    ctx.fillRect(x - 4, yPos + 8, 4, 4);
    // ขา
    ctx.fillStyle = character.pantsColor;
    ctx.fillRect(x, yPos + height - 8, 8, 8);
    ctx.fillRect(x + width - 8, yPos + height - 8, 8, 8);
  } 
  else if (character.direction === 'up') {
    // แขน
    ctx.fillStyle = character.shirtColor;
    ctx.fillRect(x, yPos + 8 + limbOffset, 8, 4);
    ctx.fillRect(x + width - 8, yPos + 8 - limbOffset, 8, 4);
    // ขา
    ctx.fillStyle = character.pantsColor;
    ctx.fillRect(x, yPos + height - 8 - limbOffset, 8, 8);
    ctx.fillRect(x + width - 8, yPos + height - 8 + limbOffset, 8, 8);
  } 
  else { // down
    // แขน
    ctx.fillStyle = character.shirtColor;
    ctx.fillRect(x, yPos + 8 - limbOffset, 8, 4);
    ctx.fillRect(x + width - 8, yPos + 8 + limbOffset, 8, 4);
    // ขา
    ctx.fillStyle = character.pantsColor;
    ctx.fillRect(x, yPos + height - 8 + limbOffset, 8, 8);
    ctx.fillRect(x + width - 8, yPos + height - 8 - limbOffset, 8, 8);
  }
}

// วาดต้นไม้แบบใหม่ (ใหญ่ขึ้น)
function drawTree(x, y) {
  // ลำต้น (ใหญ่ขึ้น)
  ctx.fillStyle = '#8B4513'; // สีน้ำตาล
  ctx.fillRect(x + TILE_SIZE/3, y + TILE_SIZE/2, TILE_SIZE/3, TILE_SIZE);
  
  // ใบไม้ (ใหญ่ขึ้น)
  ctx.fillStyle = '#228B22'; // สีเขียว
  ctx.beginPath();
  ctx.moveTo(x + TILE_SIZE/2, y);
  ctx.lineTo(x + TILE_SIZE, y + TILE_SIZE/3);
  ctx.lineTo(x + TILE_SIZE, y + TILE_SIZE);
  ctx.lineTo(x + TILE_SIZE/2, y + TILE_SIZE/2);
  ctx.lineTo(x, y + TILE_SIZE);
  ctx.lineTo(x, y + TILE_SIZE/3);
  ctx.closePath();
  ctx.fill();
  
  // รายละเอียดใบไม้
  ctx.fillStyle = '#2E8B57';
  ctx.beginPath();
  ctx.moveTo(x + TILE_SIZE/2, y + TILE_SIZE/4);
  ctx.lineTo(x + 3*TILE_SIZE/4, y + TILE_SIZE/3);
  ctx.lineTo(x + 3*TILE_SIZE/4, y + 2*TILE_SIZE/3);
  ctx.lineTo(x + TILE_SIZE/2, y + TILE_SIZE/2);
  ctx.lineTo(x + TILE_SIZE/4, y + 2*TILE_SIZE/3);
  ctx.lineTo(x + TILE_SIZE/4, y + TILE_SIZE/3);
  ctx.closePath();
  ctx.fill();
}

// วาดบ้าน
function drawHouse(x, y) {
  // ฐานบ้าน
  ctx.fillStyle = '#B22222';
  ctx.fillRect(x, y + TILE_SIZE/2, TILE_SIZE, TILE_SIZE);
  
  // หลังคา
  ctx.fillStyle = '#8B0000';
  ctx.beginPath();
  ctx.moveTo(x, y + TILE_SIZE/2);
  ctx.lineTo(x + TILE_SIZE/2, y);
  ctx.lineTo(x + TILE_SIZE, y + TILE_SIZE/2);
  ctx.closePath();
  ctx.fill();
  
  // ประตู
  ctx.fillStyle = '#8B4513';
  ctx.fillRect(x + TILE_SIZE/2 - 4, y + TILE_SIZE - 8, 8, 8);
  
  // หน้าต่าง
  ctx.fillStyle = '#87CEEB';
  ctx.fillRect(x + 8, y + TILE_SIZE/2 + 8, 8, 8);
  ctx.fillRect(x + TILE_SIZE - 16, y + TILE_SIZE/2 + 8, 8, 8);
}

// วาดคริสตัล
function drawCrystal(x, y) {
  ctx.fillStyle = '#9370DB';
  ctx.beginPath();
  ctx.moveTo(x + TILE_SIZE/2, y);
  ctx.lineTo(x + TILE_SIZE, y + TILE_SIZE/2);
  ctx.lineTo(x + TILE_SIZE/2, y + TILE_SIZE);
  ctx.lineTo(x, y + TILE_SIZE/2);
  ctx.closePath();
  ctx.fill();
  
  ctx.fillStyle = '#FFFFFF';
  ctx.beginPath();
  ctx.moveTo(x + TILE_SIZE/2, y + TILE_SIZE/4);
  ctx.lineTo(x + 3*TILE_SIZE/4, y + TILE_SIZE/2);
  ctx.lineTo(x + TILE_SIZE/2, y + 3*TILE_SIZE/4);
  ctx.lineTo(x + TILE_SIZE/4, y + TILE_SIZE/2);
  ctx.closePath();
  ctx.fill();
}

// วาดแผนที่
function drawMap() {
  const startX = Math.max(0, Math.floor(camera.x / TILE_SIZE));
  const startY = Math.max(0, Math.floor(camera.y / TILE_SIZE));
  const endX = Math.min(gameMap[0].length, Math.ceil((camera.x + camera.width) / TILE_SIZE));
  const endY = Math.min(gameMap.length, Math.ceil((camera.y + camera.height) / TILE_SIZE));
  
  for (let y = startY; y < endY; y++) {
    for (let x = startX; x < endX; x++) {
      const tile = gameMap[y][x];
      
      // วาดพื้น
      ctx.fillStyle = tile.color;
      ctx.fillRect(
        x * TILE_SIZE - camera.x,
        y * TILE_SIZE - camera.y,
        TILE_SIZE,
        TILE_SIZE
      );
      
      // วาดรายละเอียด
      if (tile.feature === 'tree') {
        drawTree(
          x * TILE_SIZE - camera.x,
          y * TILE_SIZE - camera.y
        );
      } else if (tile.feature === 'house') {
        drawHouse(
          x * TILE_SIZE - camera.x,
          y * TILE_SIZE - camera.y
        );
      } else if (tile.feature === 'crystal_cluster') {
        drawCrystal(
          x * TILE_SIZE - camera.x,
          y * TILE_SIZE - camera.y
        );
      }
    }
  }
}

// ระบบบทสนทนา
function showDialog(npcId, dialogId) {
  const currentNpcs = npcs[gameState.currentScene];
  const npc = currentNpcs.find(n => n.id === npcId);
  if (!npc) return;
  
  const dialog = npc.dialogues.find(d => d.id === dialogId);
  if (!dialog) return;
  
  gameState.currentNpc = npcId;
  gameState.currentDialog = dialogId;
  gameState.paused = true;
  
  const dialogBox = document.getElementById('dialog-box');
  const dialogText = document.getElementById('dialog-text');
  const dialogOptions = document.getElementById('dialog-options');
  
  dialogText.textContent = `${npc.name}: ${dialog.text}`;
  dialogOptions.innerHTML = '';
  
  dialog.options.forEach(option => {
    const optionElement = document.createElement('div');
    optionElement.className = 'dialog-option';
    optionElement.textContent = option.text;
    optionElement.addEventListener('click', () => {
      if (option.nextDialog === -1) {
        // จบบทสนทนา
        hideDialog();
      } else {
        // แสดงบทสนทนาถัดไป
        showDialog(npcId, option.nextDialog);
      }
      
      // ตรวจสอบการกระทำพิเศษ
      if (option.action === 'buy') {
        if (gameState.money >= option.cost) {
          gameState.money -= option.cost;
          gameState.inventory.push(option.item);
          updatePlayerStatus();
        } else {
          alert("เงินของคุณไม่พอ!");
        }
      } else if (option.quest) {
        if (!gameState.quests.includes(option.quest)) {
          gameState.quests.push(option.quest);
          updatePlayerStatus();
        }
      }
    });
    dialogOptions.appendChild(optionElement);
  });
  
  dialogBox.style.display = 'block';
}

function hideDialog() {
  document.getElementById('dialog-box').style.display = 'none';
  gameState.currentNpc = null;
  gameState.currentDialog = null;
  gameState.paused = false;
}

// เมนูเกม
function showGameMenu() {
  gameState.paused = true;
  document.getElementById('game-menu').style.display = 'flex';
  
  document.getElementById('continue-btn').addEventListener('click', () => {
    hideGameMenu();
  });
  
  document.getElementById('new-game-btn').addEventListener('click', () => {
    if (confirm("เริ่มเกมใหม่? ความคืบหน้าปัจจุบันจะหายไป")) {
      resetGame();
      hideGameMenu();
    }
  });
  
  document.getElementById('settings-btn').addEventListener('click', () => {
    alert("ตั้งค่าเกม (สามารถเพิ่มระบบตั้งค่าที่ซับซ้อนได้ที่นี่)");
  });
  
  document.getElementById('quit-btn').addEventListener('click', () => {
    if (confirm("ออกจากเกม?")) {
      window.close();
    }
  });
}

function hideGameMenu() {
  document.getElementById('game-menu').style.display = 'none';
  gameState.paused = false;
}

// เปลี่ยนฉาก
function changeScene(newScene) {
  if (gameState.currentScene === newScene || gameState.transition) return;
  
  gameState.transition = true;
  const transitionElement = document.getElementById('scene-transition');
  transitionElement.style.opacity = '1';
  
  setTimeout(() => {
    gameState.currentScene = newScene;
    gameMap = generateMap(newScene, world.width / TILE_SIZE, world.height / TILE_SIZE);
    
    // ย้ายผู้เล่นไปตำแหน่งที่เหมาะสมในฉากใหม่
    if (newScene === SCENES.TOWN) {
      player.x = world.width / 2;
      player.y = world.height - 100;
    } else if (newScene === SCENES.CAVE) {
      player.x = world.width / 2;
      player.y = 100;
    } else {
      player.x = world.width / 2;
      player.y = world.height / 2;
    }
    
    setTimeout(() => {
      transitionElement.style.opacity = '0';
      gameState.transition = false;
    }, 500);
  }, 500);
}

// อัพเดทสถานะผู้เล่น
function updatePlayerStatus() {
  document.getElementById('player-name').textContent = player.name;
  document.getElementById('hp-text').textContent = `${player.hp}/${player.maxHp}`;
  document.getElementById('energy-text').textContent = `${player.energy}/${player.maxEnergy}`;
  
  const healthPercent = (player.hp / player.maxHp) * 100;
  const energyPercent = (player.energy / player.maxEnergy) * 100;
  
  document.getElementById('health-bar').style.width = `${healthPercent}%`;
  document.getElementById('energy-bar').style.width = `${energyPercent}%`;
}

// รีเซ็ตเกม
function resetGame() {
  player.x = world.width / 2;
  player.y = world.height / 2;
  player.hp = player.maxHp;
  player.energy = player.maxEnergy;
  player.direction = 'down';
  player.moving = false;
  player.jumping = false;
  player.jumpHeight = 0;
  gameState.inventory = [];
  gameState.money = 100;
  gameState.quests = [];
  gameState.currentScene = SCENES.FOREST;
  
  // สร้างแผนที่ใหม่
  gameMap = generateMap(gameState.currentScene, world.width / TILE_SIZE, world.height / TILE_SIZE);
  
  updatePlayerStatus();
}

// ตั้งค่าควบคุม
function setupControls() {
  // -- Joystick --
  const stick = document.getElementById("joystick-stick");
  const area = document.getElementById("joystick-area");
  const joystick = { active: false, startX: 0, startY: 0, dx: 0, dy: 0 };
  const maxDist = 40;

  area.addEventListener("touchstart", (e) => {
    const touch = e.touches[0];
    joystick.active = true;
    joystick.startX = touch.clientX;
    joystick.startY = touch.clientY;
  }, { passive: true });

  area.addEventListener("touchmove", (e) => {
    if (!joystick.active) return;
    const touch = e.touches[0];
    const dx = touch.clientX - joystick.startX;
    const dy = touch.clientY - joystick.startY;
    const dist = Math.sqrt(dx * dx + dy * dy);
    const angle = Math.atan2(dy, dx);

    const limitedDist = Math.min(dist, maxDist);
    joystick.dx = Math.cos(angle) * limitedDist;
    joystick.dy = Math.sin(angle) * limitedDist;

    player.dx = joystick.dx / maxDist;
    player.dy = joystick.dy / maxDist;

    // กำหนดทิศทาง
    if (Math.abs(player.dx) > Math.abs(player.dy)) {
      player.direction = player.dx > 0 ? 'right' : 'left';
    } else {
      player.direction = player.dy > 0 ? 'down' : 'up';
    }
    
    player.moving = true;

    stick.style.left = 75 + joystick.dx + "px";
    stick.style.top = 75 + joystick.dy + "px";
  }, { passive: true });

  const resetJoystick = () => {
    joystick.active = false;
    player.dx = 0;
    player.dy = 0;
    player.moving = false;
    stick.style.left = "75px";
    stick.style.top = "75px";
  };
  area.addEventListener("touchend", resetJoystick);
  area.addEventListener("touchcancel", resetJoystick);

  // -- Action Button --
  const actionButton = document.getElementById('action-btn');
  actionButton.addEventListener('touchstart', e => {
    e.preventDefault();
    actionPressed = true;
    actionButton.style.background = 'rgba(255,80,80,0.9)';
  });
  actionButton.addEventListener('touchend', e => {
    e.preventDefault();
    actionPressed = false;
    actionButton.style.background = 'rgba(255,80,80,0.6)';
  });

  // -- Jump Button --
  const jumpButton = document.getElementById('jump-btn');
  jumpButton.addEventListener('touchstart', e => {
    e.preventDefault();
    keys.jump = true;
    jumpButton.style.background = 'rgba(80,255,80,0.9)';
  });
  jumpButton.addEventListener('touchend', e => {
    e.preventDefault();
    keys.jump = false;
    jumpButton.style.background = 'rgba(80,255,80,0.6)';
  });

  // -- Menu Button --
  const menuButton = document.getElementById('menu-btn');
  menuButton.addEventListener('touchstart', e => {
    e.preventDefault();
    menuPressed = true;
    menuButton.style.background = 'rgba(80,80,255,0.9)';
  });
  menuButton.addEventListener('touchend', e => {
    e.preventDefault();
    if (menuPressed) {
      showGameMenu();
    }
    menuPressed = false;
    menuButton.style.background = 'rgba(80,80,255,0.6)';
  });

  // -- Keyboard --
  window.addEventListener('keydown', e => {
    if (gameState.paused) return;
    
    if (e.key === 'ArrowUp' || e.key === 'w') {
      keys.up = true;
      player.direction = 'up';
      player.moving = true;
    }
    if (e.key === 'ArrowDown' || e.key === 's') {
      keys.down = true;
      player.direction = 'down';
      player.moving = true;
    }
    if (e.key === 'ArrowLeft' || e.key === 'a') {
      keys.left = true;
      player.direction = 'left';
      player.moving = true;
    }
    if (e.key === 'ArrowRight' || e.key === 'd') {
      keys.right = true;
      player.direction = 'right';
      player.moving = true;
    }
    if (e.key === ' ' && !player.jumping) {
      keys.jump = true;
    }
    if (e.key === 'e') actionPressed = true;
    if (e.key === 'Escape') showGameMenu();
  });
  
  window.addEventListener('keyup', e => {
    if (e.key === 'ArrowUp' || e.key === 'w') {
      keys.up = false;
      player.moving = keys.down || keys.left || keys.right;
    }
    if (e.key === 'ArrowDown' || e.key === 's') {
      keys.down = false;
      player.moving = keys.up || keys.left || keys.right;
    }
    if (e.key === 'ArrowLeft' || e.key === 'a') {
      keys.left = false;
      player.moving = keys.up || keys.down || keys.right;
    }
    if (e.key === 'ArrowRight' || e.key === 'd') {
      keys.right = false;
      player.moving = keys.up || keys.down || keys.left;
    }
    if (e.key === ' ') {
      keys.jump = false;
    }
    if (e.key === 'e') actionPressed = false;
  });
}

function update() {
  if (gameState.paused || gameState.transition) return;
  
  let moveX = 0;
  let moveY = 0;
  if (keys.up) moveY -= 1;
  if (keys.down) moveY += 1;
  if (keys.left) moveX -= 1;
  if (keys.right) moveX += 1;

  if (player.dx !== 0 || player.dy !== 0) {
    moveX = player.dx;
    moveY = player.dy;
  }
  
  const length = Math.sqrt(moveX * moveX + moveY * moveY);
  if (length > 0) {
    moveX = (moveX / length) * player.speed;
    moveY = (moveY / length) * player.speed;
  }

  // ตรวจสอบการกระโดด
  if (keys.jump && !player.jumping) {
    player.jumping = true;
    player.jumpHeight = 0;
  }
  
  if (player.jumping) {
    if (player.jumpHeight < player.maxJumpHeight) {
      player.jumpHeight += 2;
    } else {
      player.jumping = false;
    }
  } else if (player.jumpHeight > 0) {
    player.jumpHeight -= 2;
  }

  // ย้ายตำแหน่งผู้เล่น
  const newX = player.x + moveX;
  const newY = player.y + moveY;

  // ตรวจสอบการเดินทางไปยังฉากใหม่
  if (newX < 0 && gameState.currentScene === SCENES.FOREST) {
    changeScene(SCENES.TOWN);
    return;
  } else if (newY < 0 && gameState.currentScene === SCENES.FOREST) {
    changeScene(SCENES.CAVE);
    return;
  } else if (newY > world.height - player.height && 
             (gameState.currentScene === SCENES.TOWN || gameState.currentScene === SCENES.CAVE)) {
    changeScene(SCENES.FOREST);
    return;
  }

  // ตรวจสอบขอบเขตและสิ่งกีดขวาง
  const tileX = Math.floor(newX / TILE_SIZE);
  const tileY = Math.floor(newY / TILE_SIZE);
  
  if (tileX >= 0 && tileX < gameMap[0].length && 
      tileY >= 0 && tileY < gameMap.length) {
    const tile = gameMap[tileY][tileX];
    if (tile.walkable !== false) {
      player.x = newX;
      player.y = newY;
    }
  }

  // ตรวจสอบขอบเขตโลก
  player.x = Math.max(0, Math.min(world.width - player.width, player.x));
  player.y = Math.max(0, Math.min(world.height - player.height, player.y));

  // อัพเดทกล้อง
  camera.x = player.x - camera.width / 2 + player.width / 2;
  camera.y = player.y - camera.height / 2 + player.height / 2;

  camera.x = Math.max(0, Math.min(world.width - camera.width, camera.x));
  camera.y = Math.max(0, Math.min(world.height - camera.height, camera.y));

  // ตรวจสอบการโต้ตอบกับ NPC
  if (actionPressed) {
    actionPressed = false;
    
    const currentNpcs = npcs[gameState.currentScene];
    for (const npc of currentNpcs) {
      const dx = player.x - npc.x;
      const dy = player.y - npc.y;
      const distance = Math.sqrt(dx * dx + dy * dy);
      
      if (distance < 70) {
        showDialog(npc.id, 1); // เริ่มบทสนทนาด้วย dialog แรก
        break;
      }
    }
  }
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  // วาดแผนที่
  drawMap();
  
  // วาด NPCs
  ctx.save();
  ctx.translate(-camera.x, -camera.y);
  
  const currentNpcs = npcs[gameState.currentScene];
  for (const npc of currentNpcs) {
    drawPixelCharacter(
      npc.x, npc.y, npc.width, npc.height, 
      {
        ...npc,
        direction: 'down',
        moving: false
      }
    );
  }
  
  // วาดผู้เล่น
  drawPixelCharacter(
    player.x, player.y, player.width, player.height, 
    player,
    player.jumpHeight
  );
  
  ctx.restore();
}

// ปรับขนาด Canvas
function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  camera.width = canvas.width;
  camera.height = canvas.height;
}

// Game Loop
function gameLoop() {
  if (!gameState.paused && !gameState.transition) {
    update();
  }
  draw();
  requestAnimationFrame(gameLoop);
}

// เริ่มเกม
function initGame() {
  // สร้างแผนที่
  gameMap = generateMap(gameState.currentScene, world.width / TILE_SIZE, world.height / TILE_SIZE);
  
  // ตั้งค่าควบคุม
  setupControls();
  
  // ปรับขนาด Canvas
  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);
  
  // อัพเดทสถานะผู้เล่น
  updatePlayerStatus();
  
  // เริ่มเกมลูป
  gameLoop();
}

// เริ่มเกมเมื่อหน้าเว็บโหลดเสร็จ
window.addEventListener('load', initGame);
</script>
</body>
</html>